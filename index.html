<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Resilient Particle System</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; color: cyan; font-family: sans-serif; }
        #overlay { position: absolute; top: 10px; left: 10px; z-index: 10; pointer-events: none; }
        #webcam { position: absolute; bottom: 10px; right: 10px; width: 150px; border: 1px solid #444; border-radius: 10px; transform: scaleX(-1); }
    </style>
</head>
<body>
    <div id="overlay">
        <h2>Particle Alchemist</h2>
        <p id="status">Initializing... (Please allow camera)</p>
    </div>
    <video id="webcam" autoplay playsinline></video>

    <script src="https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        const video = document.getElementById('webcam');
        const status = document.getElementById('status');

        // 1. SETUP THREE.JS IMMEDIATELY (So you see particles even if camera fails)
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const count = 5000;
        const geo = new THREE.BufferGeometry();
        const pos = new Float32Array(count * 3);
        for(let i=0; i<count*3; i++) pos[i] = (Math.random() - 0.5) * 10;
        geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        
        const mat = new THREE.PointsMaterial({ size: 0.05, color: 0x00ffff, transparent: true, opacity: 0.8 });
        const points = new THREE.Points(geo, mat);
        scene.add(points);
        camera.position.z = 5;

        let hX = 0, hY = 0;

        // 2. SETUP HAND TRACKING
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.5 });
        hands.onResults(res => {
            if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                status.innerText = "Tracking: Active";
                const tip = res.multiHandLandmarks[0][8];
                hX = (tip.x - 0.5) * -12;
                hY = (tip.y - 0.5) * -8;
            } else {
                status.innerText = "Tracking: Hand not visible";
            }
        });

        const cam = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 640, height: 480
        });

        // Start Camera and catch errors
        cam.start().catch(err => {
            status.innerText = "Camera Error: " + err.message;
            status.style.color = "red";
        });

        function animate() {
            requestAnimationFrame(animate);
            const positions = geo.attributes.position.array;
            for(let i=0; i<count; i++) {
                const i3 = i * 3;
                positions[i3] += (hX - positions[i3]) * 0.01;
                positions[i3+1] += (hY - positions[i3+1]) * 0.01;
            }
            geo.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>

